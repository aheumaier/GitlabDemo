{
  "builders": [{
    "type": "docker",
    "image": "ubuntu",
    "commit": true,
    "changes": [
      "USER www-data",
      "WORKDIR /var/www",
      "ENV HOSTNAME www.example.com",
      "VOLUME /test1 /test2",
      "EXPOSE 80 443",
      "LABEL version=1.0",
      "ONBUILD RUN date",
      "CMD [\"nginx\", \"-g\", \"daemon off;\"]",
      "ENTRYPOINT /var/www/start.sh"
    ]
  }],
  "provisioners": [{
      "type": "shell",
      "inline_shebang": "/bin/sh -x",
      "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E sh '{{ .Path }}'",
      "inline": [
        "export DEBIAN_FRONTEND=noninteractive",
        "apt-get update && apt-get -y upgrade",
        "apt-get -y install nginx curl openssh-server ca-certificates postfix",
        "curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | bash",
        "apt-get -y install gitlab-ce",
        "mkdir -p /gitlab-data",
        "gitlab-ctl reconfigure",
        "/usr/sbin/waagent -force -deprovision+user && export HISTSIZE=0 && sync"
      ]
    },
    {
      "type": "file",
      "source": "configs/gitlab.rb",
      "destination": "/tmp/gitlab.rb"
    },
    {
      "type": "shell",
      "script": "configs/gitlab-reconfigure.sh",
      "inline_shebang": "/usr/bin/env bash",
      "execute_command": "chmod +x {{ .Path }}; {{ .Vars }} sudo -E sh '{{ .Path }}'"
    }
  ]
}